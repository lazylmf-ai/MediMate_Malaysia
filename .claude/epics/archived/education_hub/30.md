---
name: Content Infrastructure & Backend API
status: in_progress
created: 2025-10-01T11:05:51Z
updated: 2025-10-01T11:59:10Z
github: https://github.com/lazylmf-ai/MediMate_Malaysia/issues/30
depends_on: []
parallel: true
conflicts_with: []
---

# Task 031: Content Infrastructure & Backend API

## Description

Build the backend foundation for the Education Hub including database schema, REST API endpoints for content management, and a rule-based recommendation engine. This task establishes the core infrastructure that all other education features will depend on.

**Scope:**
- PostgreSQL database schema for education content, user progress, quizzes, and achievements
- REST API endpoints for content CRUD, search, recommendations, and progress tracking
- Rule-based recommendation engine matching medications/conditions to educational content
- Full-text search implementation using PostgreSQL
- AWS S3 integration for media storage

## Acceptance Criteria

- [ ] Database schema created with all required tables (education_content, education_user_progress, education_quiz_submissions, education_achievements, education_recommendations)
- [ ] All indexes and full-text search vectors configured for performance
- [ ] Content CRUD API endpoints implemented and tested (GET, POST, PUT, DELETE)
- [ ] Search API with multi-language support working (< 500ms response time)
- [ ] Recommendation engine generates personalized content based on user medications and conditions
- [ ] User progress tracking API endpoints functional
- [ ] Quiz submission and scoring API implemented
- [ ] AWS S3 integration for content media upload/retrieval
- [ ] All API endpoints have error handling and validation
- [ ] API documentation generated (Swagger/OpenAPI)

## Technical Details

### Database Schema

**Tables to create:**
```sql
-- education_content: Stores all educational materials
-- education_user_progress: Tracks user viewing and completion
-- education_quiz_submissions: Records quiz attempts and scores
-- education_achievements: User badges and gamification
-- education_recommendations: Cached personalized recommendations
```

**Key features:**
- Multi-language JSONB fields for content (MS, EN, ZH, TA)
- Full-text search vectors for all languages
- Denormalized analytics fields (view_count, average_rating)
- Indexes on frequently queried fields

### API Endpoints

**Content Management:**
- `GET /api/education/content` - List content with filters (pagination, category, type)
- `GET /api/education/content/:id` - Get specific content
- `GET /api/education/content/:id/related` - Get related content
- `POST /api/education/content` - Create content (admin only)
- `PUT /api/education/content/:id` - Update content (admin only)
- `DELETE /api/education/content/:id` - Delete content (admin only)

**Search & Discovery:**
- `GET /api/education/search` - Full-text search across all languages
- `GET /api/education/categories` - List all categories
- `GET /api/education/recommendations` - Get personalized recommendations

**Progress Tracking:**
- `POST /api/education/progress/view` - Track content view
- `POST /api/education/progress/complete` - Mark content complete
- `GET /api/education/progress/user` - Get user progress summary
- `POST /api/education/quiz/submit` - Submit quiz answers
- `GET /api/education/achievements` - Get user achievements

**Sharing:**
- `POST /api/education/share` - Share content with family circle
- `GET /api/education/shared` - Get shared content

**Sync:**
- `GET /api/education/sync` - Batch content sync for offline
- `POST /api/education/download` - Request offline content package

### Recommendation Engine Logic

```typescript
class ContentRecommendationService {
  async getRecommendations(userId: string): Promise<Content[]> {
    // 1. Get user's medications
    const medications = await getMedicationsByUserId(userId);

    // 2. Match content by medication IDs (exact match)
    const medicationContent = await this.getContentByMedications(medications);

    // 3. Detect chronic conditions from medication profile
    const conditions = this.detectConditionsFromMedications(medications);

    // 4. Match content by conditions (ICD-10 codes)
    const conditionContent = await this.getContentByConditions(conditions);

    // 5. Check adherence rate for intervention triggers
    const adherence = await getAdherenceRate(userId);
    let interventionContent = [];
    if (adherence < 0.6) {
      // Low adherence: recommend motivational/importance content
      interventionContent = await this.getMotivationalContent();
    }

    // 6. Prioritize and deduplicate
    const recommendations = this.prioritize([
      ...medicationContent,
      ...conditionContent,
      ...interventionContent
    ]);

    // 7. Return top 20 recommendations
    return recommendations.slice(0, 20);
  }

  private detectConditionsFromMedications(medications: Medication[]): string[] {
    // Map common medications to conditions
    // E.g., Metformin → Diabetes (ICD-10: E11)
    // E.g., Amlodipine → Hypertension (ICD-10: I10)
    const conditionMap = {
      'metformin': ['E11'], // Type 2 Diabetes
      'amlodipine': ['I10'], // Hypertension
      'atorvastatin': ['E78'], // Hyperlipidemia
      // ... more mappings
    };

    const conditions = new Set<string>();
    medications.forEach(med => {
      const medConditions = conditionMap[med.genericName.toLowerCase()];
      if (medConditions) {
        medConditions.forEach(c => conditions.add(c));
      }
    });

    return Array.from(conditions);
  }
}
```

### Files to Create/Modify

**Backend:**
```
backend/src/
├── models/education/
│   ├── EducationContent.model.ts
│   ├── UserProgress.model.ts
│   ├── QuizSubmission.model.ts
│   └── Achievement.model.ts
├── services/education/
│   ├── ContentService.ts
│   ├── RecommendationService.ts
│   ├── ProgressTrackingService.ts
│   ├── QuizService.ts
│   └── SearchService.ts
├── controllers/education/
│   ├── ContentController.ts
│   ├── ProgressController.ts
│   ├── SearchController.ts
│   └── RecommendationController.ts
├── routes/education.ts
└── database/migrations/
    └── 009_education_hub.sql
```

## Dependencies

**External:**
- [ ] PostgreSQL database access
- [ ] AWS S3 bucket for content storage (create: `medimatemy-education-content`)
- [ ] Existing medication management API for user medication data
- [ ] Existing adherence tracking API for adherence rates

**Internal:**
- [ ] Existing backend infrastructure (Node.js + Express)
- [ ] Existing authentication middleware (OAuth 2.0)
- [ ] Existing database connection and migration system

## Effort Estimate

- **Size:** L (Large)
- **Hours:** 80 hours
- **Breakdown:**
  - Database schema design and migration: 12 hours
  - Content CRUD API: 16 hours
  - Search implementation: 12 hours
  - Recommendation engine: 20 hours
  - Progress tracking API: 10 hours
  - Quiz API: 10 hours
- **Parallel:** true (can work alongside frontend tasks once API contracts are defined)

## Definition of Done

- [ ] All database tables created and indexed
- [ ] All API endpoints implemented with TypeScript types
- [ ] API integration tests passing (>80% coverage)
- [ ] Recommendation engine tested with sample user data
- [ ] Search functionality tested in all 4 languages
- [ ] API documentation published (Swagger UI accessible)
- [ ] AWS S3 integration verified (upload/download working)
- [ ] Code reviewed and approved
- [ ] Merged to development branch
- [ ] Deployed to staging environment

## Testing Requirements

**Unit Tests:**
- ContentService CRUD operations
- RecommendationService logic (medication/condition matching)
- QuizService scoring logic
- SearchService multi-language queries

**Integration Tests:**
- Full API endpoint workflows
- Database transaction handling
- S3 upload/download
- Multi-language content retrieval

**Performance Tests:**
- Search response time < 500ms
- Recommendation generation < 1s
- Content list pagination < 1s
- Database query optimization verification
