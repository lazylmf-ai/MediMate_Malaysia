---
name: Family Circle & Remote Monitoring
status: completed
created: 2025-09-11T02:09:59Z
updated: 2025-09-26T08:45:00Z
github: https://github.com/lazylmf-ai/MediMate_Malaysia/issues/25
depends_on: [021, 024]
parallel: true
conflicts_with: []
---

# Task 005: Family Circle & Remote Monitoring

## Overview
Implement a comprehensive family circle system that enables remote monitoring of medication adherence, emergency notifications, and collaborative care management through role-based access control and real-time family dashboards.

## Business Requirements

### Core Features
- **Multi-User Family Accounts**: Hierarchical family structure with multiple patients and caregivers
- **Role-Based Access Control**: Patient, Primary Caregiver, Family Member, Healthcare Provider roles
- **Family Dashboard**: Real-time medication status across all family members
- **Emergency Notification System**: Immediate alerts for missed critical medications
- **Family Invitation System**: Secure invitation and connection workflow
- **Remote Monitoring**: Non-intrusive monitoring with privacy controls

### User Stories
1. **As a primary caregiver**, I want to monitor my elderly parent's medication adherence without being intrusive
2. **As a family member**, I want to receive emergency notifications if someone misses critical medications
3. **As a patient**, I want to control what information my family can see about my medications
4. **As a healthcare provider**, I want to monitor multiple patients' adherence patterns
5. **As a spouse**, I want to help remind my partner about medications while respecting their autonomy

## Technical Requirements

### Architecture
- **Family Management Service**: Core family relationship and permission management
- **Dashboard Service**: Real-time family medication status aggregation
- **Notification Service**: Emergency and routine family notifications via WebSocket
- **Invitation Service**: Secure family member invitation and onboarding
- **Privacy Service**: Granular privacy controls and data sharing permissions

### Implementation Details

#### 1. Family Relationship Management
```typescript
interface FamilyCircle {
  id: string;
  name: string;
  createdBy: string;
  members: FamilyMember[];
  settings: FamilySettings;
  emergencyContacts: EmergencyContact[];
  createdAt: Date;
  updatedAt: Date;
}

interface FamilyMember {
  userId: string;
  role: FamilyRole;
  permissions: Permission[];
  joinedAt: Date;
  invitedBy: string;
  status: 'active' | 'invited' | 'suspended';
  privacySettings: PrivacySettings;
}

type FamilyRole = 'patient' | 'primary_caregiver' | 'family_member' | 'healthcare_provider';

interface Permission {
  resource: 'medications' | 'adherence' | 'health_data' | 'emergency_contacts';
  actions: ('view' | 'edit' | 'delete')[];
  conditions?: PermissionCondition[];
}
```

#### 2. Real-Time Family Dashboard
- **WebSocket Integration**: Leverage existing real-time infrastructure
- **State Management**: React Native family state with Redux/Zustand
- **Dashboard Components**: Modular medication status widgets
- **Performance Optimization**: Efficient data aggregation and caching

#### 3. Emergency Notification System
```typescript
interface EmergencyTrigger {
  type: 'missed_critical_medication' | 'no_app_activity' | 'manual_emergency';
  patientId: string;
  medicationId?: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  triggerTime: Date;
  autoResolve: boolean;
  escalationRules: EscalationRule[];
}

interface EscalationRule {
  delay: number; // minutes
  notificationMethods: ('push' | 'sms' | 'call' | 'email')[];
  recipients: string[]; // family member IDs
  message: string;
}
```

#### 4. Privacy and Consent Management
- **Granular Controls**: Per-medication, per-family-member privacy settings
- **Consent Tracking**: Audit trail for privacy preferences changes
- **Data Minimization**: Share only necessary information based on role
- **Revocation**: Immediate access revocation capabilities

### Integration Points

#### React Native Family State Management
```typescript
// Family State with Zustand
interface FamilyState {
  currentFamily: FamilyCircle | null;
  familyMembers: FamilyMember[];
  dashboardData: FamilyDashboardData;
  notifications: FamilyNotification[];
  actions: {
    joinFamily: (inviteCode: string) => Promise<void>;
    inviteMember: (email: string, role: FamilyRole) => Promise<void>;
    updatePermissions: (memberId: string, permissions: Permission[]) => Promise<void>;
    sendEmergencyAlert: (type: string, details: any) => Promise<void>;
    updatePrivacySettings: (settings: PrivacySettings) => Promise<void>;
  };
}
```

#### WebSocket Integration
- **Family Channels**: Real-time channels per family circle
- **Event Types**: Medication taken, missed, emergency, status updates
- **Connection Management**: Automatic reconnection and offline message queue
- **Message Filtering**: Role-based message filtering on client side

### Database Schema

#### Family Management Tables
```sql
CREATE TABLE family_circles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  created_by TEXT REFERENCES users(id),
  settings TEXT, -- JSON family settings
  emergency_contacts TEXT, -- JSON array
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE family_members (
  id TEXT PRIMARY KEY,
  family_id TEXT REFERENCES family_circles(id),
  user_id TEXT REFERENCES users(id),
  role TEXT CHECK (role IN ('patient', 'primary_caregiver', 'family_member', 'healthcare_provider')),
  permissions TEXT, -- JSON permissions array
  privacy_settings TEXT, -- JSON privacy configuration
  status TEXT CHECK (status IN ('active', 'invited', 'suspended')) DEFAULT 'invited',
  invited_by TEXT REFERENCES users(id),
  joined_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(family_id, user_id)
);

CREATE TABLE family_invitations (
  id TEXT PRIMARY KEY,
  family_id TEXT REFERENCES family_circles(id),
  invited_email TEXT,
  invited_by TEXT REFERENCES users(id),
  role TEXT,
  invite_code TEXT UNIQUE,
  expires_at DATETIME,
  used_at DATETIME,
  status TEXT CHECK (status IN ('pending', 'accepted', 'expired', 'revoked')) DEFAULT 'pending',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE family_notifications (
  id TEXT PRIMARY KEY,
  family_id TEXT REFERENCES family_circles(id),
  sender_id TEXT REFERENCES users(id),
  notification_type TEXT,
  severity TEXT CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  message TEXT,
  metadata TEXT, -- JSON additional data
  recipients TEXT, -- JSON array of member IDs
  delivery_status TEXT, -- JSON delivery tracking
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  resolved_at DATETIME
);

CREATE TABLE family_activity_log (
  id TEXT PRIMARY KEY,
  family_id TEXT REFERENCES family_circles(id),
  user_id TEXT REFERENCES users(id),
  action_type TEXT,
  resource_type TEXT,
  resource_id TEXT,
  details TEXT, -- JSON action details
  ip_address TEXT,
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Acceptance Criteria

### Functional Requirements
1. **Family Management**
   - [ ] Users can create family circles with custom names
   - [ ] Multiple family circles per user supported
   - [ ] Role-based permissions enforced consistently
   - [ ] Family member status management (active/suspended)

2. **Invitation System**
   - [ ] Secure invitation codes with expiration (7 days)
   - [ ] Email-based invitation flow
   - [ ] QR code generation for easy mobile joining
   - [ ] Invitation revocation capability

3. **Real-Time Dashboard**
   - [ ] Live medication status updates via WebSocket
   - [ ] Family member location on dashboard (with consent)
   - [ ] Adherence statistics and trends visualization
   - [ ] Offline-capable dashboard with sync

4. **Emergency Notifications**
   - [ ] Critical medication missed triggers immediate alerts
   - [ ] Escalation rules configurable per family
   - [ ] Multiple notification channels (push, SMS, email)
   - [ ] Emergency contact integration

5. **Privacy Controls**
   - [ ] Granular medication visibility controls
   - [ ] Role-specific information filtering
   - [ ] Consent tracking and audit trail
   - [ ] Data sharing preferences per family member

### Performance Requirements
1. **Real-Time Updates**: < 2 seconds from event to family notification
2. **Dashboard Load**: < 3 seconds for family dashboard initial load
3. **Scalability**: Support families up to 20 members
4. **Offline Capability**: 24-hour offline dashboard functionality

### Security Requirements
1. **Access Control**: Role-based permissions enforced at API level
2. **Data Encryption**: All family data encrypted at rest and in transit
3. **Audit Trail**: Complete activity logging for compliance
4. **Privacy Compliance**: GDPR-compliant data handling and deletion

## Testing Strategy

### Unit Tests
- Family relationship management logic
- Permission validation and enforcement
- Privacy settings filtering
- Emergency notification triggers

### Integration Tests
- WebSocket family channel functionality
- Real-time dashboard updates
- Cross-platform invitation flow
- Emergency escalation workflows

### User Acceptance Tests
- Multi-generational family scenarios
- Healthcare provider integration
- Privacy boundary testing
- Emergency response simulation

## Dependencies
- **Task 001**: User authentication and profile management
- **Task 004**: Smart reminder system for emergency triggers
- **External**: Email service for invitations
- **External**: SMS service for emergency notifications
- **Existing**: WebSocket infrastructure for real-time updates

## Deliverables
1. Family circle management service
2. Role-based access control system
3. Real-time family dashboard with React Native components
4. Emergency notification and escalation system
5. Secure family invitation workflow
6. Privacy control and consent management
7. WebSocket integration for family channels
8. Comprehensive test suite
9. Family management user documentation

## Effort Estimation
**Large (5-6 days)**
- Day 1: Family relationship management and database schema
- Day 2: Role-based access control and permissions system
- Day 3: Real-time dashboard with WebSocket integration
- Day 4: Emergency notification and escalation system
- Day 5: Family invitation workflow and privacy controls
- Day 6: Testing, optimization, and documentation

## Success Metrics
1. **Family Adoption**: 40% of users join or create family circles
2. **Emergency Response**: < 5 minutes average emergency response time
3. **Privacy Satisfaction**: > 90% users comfortable with privacy controls
4. **Caregiver Engagement**: 60% of caregivers actively use family dashboard
5. **Technical Performance**: 99.5% uptime for family notifications
6. **User Retention**: 80% of family members remain active after 30 days

## Risk Mitigation
1. **Privacy Concerns**: Implement privacy-by-design with granular controls
2. **Family Conflicts**: Clear role definitions and dispute resolution process
3. **Notification Fatigue**: Intelligent notification throttling and preferences
4. **Technical Complexity**: Phased rollout with progressive feature enablement
5. **Scalability**: Load testing with large family scenarios