---
name: Integration Layer
status: in_progress
created: 2025-10-01T11:05:51Z
updated: 2025-10-03T01:53:01Z
github: https://github.com/lazylmf-ai/MediMate_Malaysia/issues/34
depends_on: [30, 31, 32]
parallel: true
conflicts_with: []
---

# Task 035: Integration Layer

## Description

Build the integration layer that connects the Education Hub with existing MediMate modules including medication management, family circle, cultural intelligence, and adherence tracking. This creates a cohesive ecosystem where educational interventions are triggered contextually and learning progress is visible across the platform.

**Scope:**
- Medication module integration (show educational content in medication detail view)
- Family circle integration (share content, track family member progress)
- Cultural intelligence integration (respect prayer times for learning reminders)
- Adherence tracking integration (trigger educational interventions for low adherence)
- Deep linking between modules
- Unified notification system for education events

## Acceptance Criteria

- [ ] Medication detail screen displays related educational content
- [ ] Educational content can be shared with family circle members
- [ ] Family dashboard shows learning progress of all members
- [ ] Learning reminders respect prayer times from cultural settings
- [ ] Low adherence (< 60%) triggers educational intervention recommendations
- [ ] Deep links navigate between modules seamlessly
- [ ] Push notifications for education events (new content, achievements) integrated
- [ ] Family members receive notifications when content is shared
- [ ] Educational content recommendations update when medications change
- [ ] Progress visible in family member profiles
- [ ] Cultural preferences (language, prayer times) applied to education experience
- [ ] Analytics track cross-module engagement

## Technical Details

### Medication Module Integration

**Medication Detail Education Section:**
```tsx
// frontend/src/screens/medications/MedicationDetailScreen.tsx (modify existing)
import { EducationContentSection } from '@/components/education/EducationContentSection';

export const MedicationDetailScreen: React.FC = ({ route }) => {
  const { medicationId } = route.params;
  const dispatch = useDispatch();
  const medication = useSelector(state => selectMedicationById(state, medicationId));
  const [educationalContent, setEducationalContent] = useState<EducationContent[]>([]);

  useEffect(() => {
    // Fetch educational content related to this medication
    const loadEducation = async () => {
      const content = await educationService.getContentByMedication(medicationId);
      setEducationalContent(content);
    };
    loadEducation();
  }, [medicationId]);

  return (
    <ScrollView>
      {/* Existing medication details */}
      <MedicationInfo medication={medication} />
      <DosageSchedule medication={medication} />
      <AdherenceStats medication={medication} />

      {/* NEW: Educational content section */}
      <EducationContentSection
        title="Learn About This Medication"
        content={educationalContent}
        onContentPress={(content) => navigation.navigate('Education', {
          screen: 'ContentDetail',
          params: { id: content.id }
        })}
        emptyMessage="No educational content available for this medication yet."
      />

      {/* Existing sections */}
      <SideEffects medication={medication} />
      <Interactions medication={medication} />
    </ScrollView>
  );
};
```

**Educational Content Recommendation on Medication Changes:**
```typescript
// frontend/src/services/educationIntegrationService.ts
class EducationIntegrationService {
  /**
   * Called when user adds/updates medications
   * Triggers recommendation refresh
   */
  async onMedicationChange(userId: string, medicationIds: string[]): Promise<void> {
    // Refresh personalized recommendations
    await educationService.refreshRecommendations(userId);

    // Check if new educational content available
    const newContent = await educationService.getNewContentForMedications(medicationIds);

    if (newContent.length > 0) {
      // Send notification about new relevant content
      await notificationService.send({
        userId,
        type: 'EDUCATION_NEW_CONTENT',
        title: 'New Learning Content Available',
        body: `We've added educational materials about your medications.`,
        data: {
          screen: 'Education',
          params: { tab: 'recommended' }
        }
      });
    }
  }

  /**
   * Get educational content by medication ID or generic name
   */
  async getContentByMedication(medicationId: string): Promise<EducationContent[]> {
    // Fetch from backend
    const response = await apiClient.get(`/api/education/content/medication/${medicationId}`);
    return response.data;
  }
}
```

### Family Circle Integration

**Share Content with Family:**
```tsx
// frontend/src/components/education/ShareButton.tsx (extend existing)
import { useFamilyCircle } from '@/hooks/useFamilyCircle';

interface ShareButtonProps {
  contentId: string;
  contentTitle: string;
}

export const ShareButton: React.FC<ShareButtonProps> = ({ contentId, contentTitle }) => {
  const { familyMembers } = useFamilyCircle();
  const [showModal, setShowModal] = useState(false);

  const handleShare = async (memberIds: string[]) => {
    try {
      await educationService.shareContent(contentId, memberIds);

      // Send notification to family members
      for (const memberId of memberIds) {
        await notificationService.send({
          userId: memberId,
          type: 'EDUCATION_CONTENT_SHARED',
          title: 'New Learning Content Shared',
          body: `${currentUser.name} shared "${contentTitle}" with you.`,
          data: {
            screen: 'Education',
            params: { contentId }
          }
        });
      }

      Alert.alert('Success', 'Content shared with family members');
      setShowModal(false);
    } catch (error) {
      Alert.alert('Error', 'Failed to share content');
    }
  };

  return (
    <>
      <TouchableOpacity style={styles.shareButton} onPress={() => setShowModal(true)}>
        <Icon name="share" size={24} color="#2196F3" />
        <Text style={styles.shareText}>Share with Family</Text>
      </TouchableOpacity>

      <Modal visible={showModal} transparent animationType="slide">
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Share with Family</Text>

            <FlatList
              data={familyMembers}
              keyExtractor={(item) => item.id}
              renderItem={({ item }) => (
                <FamilyMemberCheckbox
                  member={item}
                  onToggle={(selected) => toggleMember(item.id, selected)}
                />
              )}
            />

            <View style={styles.modalButtons}>
              <Button title="Cancel" onPress={() => setShowModal(false)} />
              <Button title="Share" onPress={() => handleShare(selectedMembers)} />
            </View>
          </View>
        </View>
      </Modal>
    </>
  );
};
```

**Family Learning Progress Dashboard:**
```tsx
// frontend/src/screens/family/FamilyLearningScreen.tsx (new)
export const FamilyLearningScreen: React.FC = () => {
  const { familyMembers } = useFamilyCircle();
  const [learningProgress, setLearningProgress] = useState<Record<string, any>>({});

  useEffect(() => {
    const loadProgress = async () => {
      const progress = {};
      for (const member of familyMembers) {
        progress[member.id] = await educationService.getUserProgress(member.id);
      }
      setLearningProgress(progress);
    };
    loadProgress();
  }, [familyMembers]);

  return (
    <ScrollView>
      <Text style={styles.title}>Family Learning Progress</Text>

      {familyMembers.map(member => (
        <View key={member.id} style={styles.memberCard}>
          <View style={styles.memberHeader}>
            <Avatar source={{ uri: member.avatar }} size={48} />
            <Text style={styles.memberName}>{member.name}</Text>
          </View>

          {learningProgress[member.id] && (
            <View style={styles.progressStats}>
              <StatItem
                icon="book"
                label="Content Viewed"
                value={learningProgress[member.id].contentViewed}
              />
              <StatItem
                icon="quiz"
                label="Quizzes Passed"
                value={learningProgress[member.id].quizzesPassed}
              />
              <StatItem
                icon="fire"
                label="Day Streak"
                value={learningProgress[member.id].currentStreak}
              />
            </View>
          )}

          <TouchableOpacity
            style={styles.viewButton}
            onPress={() => navigation.navigate('MemberLearningDetail', { memberId: member.id })}
          >
            <Text style={styles.viewButtonText}>View Details</Text>
          </TouchableOpacity>
        </View>
      ))}
    </ScrollView>
  );
};
```

### Cultural Intelligence Integration

**Prayer Time Aware Learning Reminders:**
```typescript
// backend/src/services/education/LearningReminderService.ts
import { CulturalIntelligenceService } from '../cultural/CulturalIntelligenceService';
import { PrayerTimeService } from '../cultural/PrayerTimeService';

class LearningReminderService {
  private culturalService: CulturalIntelligenceService;
  private prayerTimeService: PrayerTimeService;

  /**
   * Schedule learning reminder respecting cultural preferences
   */
  async scheduleLearningReminder(userId: string, preferredTime: string): Promise<void> {
    // Get user's cultural preferences
    const culturalPrefs = await this.culturalService.getUserPreferences(userId);

    // If user is Muslim, check prayer times
    if (culturalPrefs.religion === 'islam') {
      const prayerTimes = await this.prayerTimeService.getTodayPrayerTimes(
        culturalPrefs.location.latitude,
        culturalPrefs.location.longitude
      );

      // Check if preferred time conflicts with prayer time
      const conflictsPrayer = this.checkPrayerTimeConflict(preferredTime, prayerTimes);

      if (conflictsPrayer) {
        // Adjust reminder to after prayer time
        const adjustedTime = this.adjustForPrayerTime(preferredTime, prayerTimes);

        console.log(`[LearningReminder] Adjusted reminder from ${preferredTime} to ${adjustedTime} to respect prayer time`);

        await this.scheduleNotification(userId, adjustedTime, {
          title: 'Time to Learn',
          body: 'Continue your health education journey',
          respectsPrayerTime: true
        });

        return;
      }
    }

    // No conflict, schedule as requested
    await this.scheduleNotification(userId, preferredTime, {
      title: 'Time to Learn',
      body: 'Continue your health education journey'
    });
  }

  private checkPrayerTimeConflict(time: string, prayerTimes: any): boolean {
    // Check if reminder falls within ±30 minutes of any prayer time
    const reminderTime = new Date(time);
    const bufferMinutes = 30;

    for (const prayerTime of Object.values(prayerTimes)) {
      const prayer = new Date(prayerTime as string);
      const diffMinutes = Math.abs((reminderTime.getTime() - prayer.getTime()) / 60000);

      if (diffMinutes <= bufferMinutes) {
        return true;
      }
    }

    return false;
  }

  private adjustForPrayerTime(time: string, prayerTimes: any): string {
    // Find next safe window after prayer time
    // Implementation details...
    return adjustedTime;
  }
}
```

**Language Preference Integration:**
```typescript
// frontend/src/screens/education/EducationHomeScreen.tsx (modify)
import { useCulturalPreferences } from '@/hooks/useCulturalPreferences';

export const EducationHomeScreen: React.FC = () => {
  const { language, culturalSettings } = useCulturalPreferences();
  const dispatch = useDispatch();

  useEffect(() => {
    // Fetch content in user's preferred language
    dispatch(fetchRecommendations({ language }));
    dispatch(fetchCategories({ language }));
  }, [language]);

  // Educational content automatically displays in user's preferred language
  // from cultural settings (MS, EN, ZH, TA)

  return (
    <ScrollView>
      <PersonalizedGreeting language={language} />
      <RecommendationCarousel language={language} />
      {/* ... rest of content */}
    </ScrollView>
  );
};
```

### Adherence Tracking Integration

**Low Adherence Educational Intervention:**
```typescript
// backend/src/services/education/AdherenceInterventionService.ts
import { AdherenceTrackingService } from '../adherence/AdherenceTrackingService';

class AdherenceInterventionService {
  private adherenceService: AdherenceTrackingService;

  /**
   * Check adherence and trigger educational interventions
   * Called daily or after adherence events
   */
  async checkAndIntervent(userId: string): Promise<void> {
    const adherenceRate = await this.adherenceService.getAdherenceRate(userId, 30); // Last 30 days

    // Low adherence threshold: 60%
    if (adherenceRate < 0.6) {
      console.log(`[AdherenceIntervention] Low adherence detected: ${(adherenceRate * 100).toFixed(1)}%`);

      // Get motivational and educational content
      const interventionContent = await this.getAdherenceInterventionContent(userId, adherenceRate);

      // Send notification with content recommendation
      await notificationService.send({
        userId,
        type: 'EDUCATION_ADHERENCE_INTERVENTION',
        title: 'Let\'s Improve Together',
        body: 'Learn why taking your medications as prescribed is important.',
        data: {
          screen: 'Education',
          params: { contentId: interventionContent.id }
        }
      });

      // Log intervention
      await this.logIntervention(userId, adherenceRate, interventionContent.id);
    }
  }

  private async getAdherenceInterventionContent(userId: string, adherenceRate: number): Promise<EducationContent> {
    // Get user's medications to personalize content
    const medications = await medicationService.getUserMedications(userId);

    // Find content about medication importance, side effects, or adherence strategies
    const content = await educationService.getInterventionContent({
      type: 'adherence',
      medications,
      adherenceRate,
      language: await this.getUserLanguage(userId)
    });

    return content;
  }

  /**
   * Display adherence intervention banner in Education Hub
   */
  async getInterventionBanner(userId: string): Promise<InterventionBanner | null> {
    const adherenceRate = await this.adherenceService.getAdherenceRate(userId, 30);

    if (adherenceRate < 0.6) {
      return {
        type: 'warning',
        title: 'Your Medication Adherence Needs Attention',
        message: `You've taken ${(adherenceRate * 100).toFixed(0)}% of your prescribed doses in the last 30 days.`,
        action: {
          label: 'Learn More',
          screen: 'ContentDetail',
          params: { id: await this.getAdherenceContentId(userId) }
        }
      };
    }

    return null;
  }
}
```

**Adherence Banner in Education Hub:**
```tsx
// frontend/src/components/education/AdherenceInterventionBanner.tsx
export const AdherenceInterventionBanner: React.FC = () => {
  const [banner, setBanner] = useState<InterventionBanner | null>(null);

  useEffect(() => {
    const loadBanner = async () => {
      const interventionBanner = await educationService.getAdherenceInterventionBanner();
      setBanner(interventionBanner);
    };
    loadBanner();
  }, []);

  if (!banner) return null;

  return (
    <View style={[styles.banner, styles[banner.type]]}>
      <Icon name="warning" size={24} color="#F57C00" />
      <View style={styles.bannerContent}>
        <Text style={styles.bannerTitle}>{banner.title}</Text>
        <Text style={styles.bannerMessage}>{banner.message}</Text>
      </View>
      <TouchableOpacity
        style={styles.bannerAction}
        onPress={() => navigation.navigate(banner.action.screen, banner.action.params)}
      >
        <Text style={styles.actionText}>{banner.action.label}</Text>
      </TouchableOpacity>
    </View>
  );
};
```

### Deep Linking Architecture

**Deep Link Configuration:**
```typescript
// frontend/src/navigation/deepLinking.ts
const linking = {
  prefixes: ['medimate://', 'https://app.medimate.my'],
  config: {
    screens: {
      Education: {
        screens: {
          EducationHome: 'education',
          ContentDetail: 'education/content/:id',
          CategoryBrowse: 'education/category/:category',
          QuizScreen: 'education/quiz/:quizId',
          LearningProgress: 'education/progress'
        }
      },
      Medications: {
        screens: {
          MedicationDetail: 'medications/:id'
        }
      },
      Family: {
        screens: {
          FamilyLearning: 'family/learning'
        }
      }
    }
  }
};

// Usage: medimate://education/content/abc123
// Opens ContentDetailScreen with contentId="abc123"
```

### Files to Create/Modify

**Frontend:**
```
frontend/src/
├── services/
│   ├── educationIntegrationService.ts
│   └── deepLinkingService.ts
├── screens/
│   ├── medications/
│   │   └── MedicationDetailScreen.tsx (modify)
│   ├── family/
│   │   ├── FamilyLearningScreen.tsx
│   │   └── MemberLearningDetailScreen.tsx
│   └── education/
│       └── EducationHomeScreen.tsx (modify)
├── components/education/
│   ├── EducationContentSection.tsx
│   ├── AdherenceInterventionBanner.tsx
│   └── ShareButton.tsx (modify)
├── hooks/
│   ├── useCulturalPreferences.ts
│   └── useFamilyCircle.ts
└── navigation/
    └── deepLinking.ts (modify)
```

**Backend:**
```
backend/src/
├── services/education/
│   ├── EducationIntegrationService.ts
│   ├── LearningReminderService.ts
│   └── AdherenceInterventionService.ts
├── controllers/education/
│   └── IntegrationController.ts
└── jobs/
    └── adherenceInterventionJob.ts
```

## Dependencies

**External:**
- [ ] Task 031 backend API (content, recommendations)
- [ ] Task 032 frontend UI (screens, components)
- [ ] Task 033 progress tracking system
- [ ] Existing medication management API
- [ ] Existing family circle API
- [ ] Existing cultural intelligence API (prayer times, preferences)
- [ ] Existing adherence tracking API
- [ ] Existing notification service

**Internal:**
- [ ] Deep linking infrastructure (React Navigation)
- [ ] Push notification system (FCM/APNS)
- [ ] Redux store (cross-module state)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 40 hours
- **Breakdown:**
  - Medication module integration: 10 hours
  - Family circle integration: 10 hours
  - Cultural intelligence integration: 8 hours
  - Adherence tracking integration: 8 hours
  - Deep linking setup: 4 hours
- **Parallel:** true (can work after Tasks 031, 31, 033 complete)

## Definition of Done

- [ ] Medication detail screen shows related educational content
- [ ] Content can be shared with family members
- [ ] Family learning progress visible in family dashboard
- [ ] Learning reminders respect prayer times
- [ ] Low adherence triggers educational interventions
- [ ] Deep links work across all modules
- [ ] Push notifications integrated for education events
- [ ] Analytics tracking cross-module engagement
- [ ] Integration tests passing (>75% coverage)
- [ ] Code reviewed and approved
- [ ] Tested on iOS and Android devices
- [ ] Merged to development branch

## Testing Requirements

**Unit Tests:**
- EducationIntegrationService methods
- LearningReminderService prayer time logic
- AdherenceInterventionService threshold detection
- Deep linking URL parsing

**Integration Tests:**
- Full medication-to-education navigation flow
- Content sharing workflow (sender → notification → receiver)
- Family progress dashboard data loading
- Prayer time conflict detection and adjustment
- Adherence intervention trigger and notification
- Deep link navigation from notifications

**Manual Testing:**
- Share content with family member and verify notification
- Add medication and verify education recommendation updates
- Set learning reminder during prayer time and verify adjustment
- Lower adherence below 60% and verify intervention
- Test deep links from push notifications
- Verify cultural preferences applied (language, prayer times)
