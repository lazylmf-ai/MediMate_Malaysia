---
name: Week 2 - Real Authentication & Push Notifications
epic: mvp_beta_readiness
status: backlog
priority: P0
created: 2025-10-04T12:24:43Z
github: https://github.com/lazylmf-ai/MediMate_Malaysia/issues/44
effort: 5 days
assignee: Wiring Squad + Backend Engineer
dependencies: [42]
---

# Issue #43: Week 2 - Real Authentication & Push Notifications

**Epic:** MVP Beta Readiness
**Priority:** P0 - Critical
**Timeline:** Days 6-10 (Week 2)
**Budget:** RM 110K
**Depends On:** Issue #42 (Week 1 complete)

## Overview

Replace all mock authentication and notification systems with real Firebase integrations. This is critical for production launch as no actual user authentication or notification delivery currently works.

## Problem Statement

**Current State:**
- Authentication always succeeds with mock AsyncStorage
- Push notifications log to AsyncStorage instead of delivering
- No PDPA consent in registration flow
- Session management simulated

**Desired State:**
- Real Firebase Authentication with email/password
- Real Firebase Cloud Messaging delivering push notifications
- PDPA consent integrated into registration
- Secure session management with Redis

## Acceptance Criteria

### Day 1-3: Firebase Authentication
- [ ] Firebase project created and configured
- [ ] Firebase Auth SDK integrated (frontend)
- [ ] Email/password authentication working
- [ ] Google OAuth working
- [ ] Apple Sign-In working
- [ ] All mock auth code removed
- [ ] Session tokens persisted securely

### Day 3-4: PDPA Consent Integration
- [ ] Consent screen in registration flow
- [ ] Consent logging to database
- [ ] Consent version tracking
- [ ] User can review/update consent
- [ ] Audit trail for consent changes

### Day 4-5: Push Notifications
- [ ] Firebase Cloud Messaging configured
- [ ] Push notification permissions requested
- [ ] FCM token registration working
- [ ] Test push notifications delivered
- [ ] Reminder engine connected to FCM
- [ ] All AsyncStorage notification mocks removed

## Technical Specification

### Firebase Project Setup

**Configuration:**
```json
{
  "projectId": "medimate-malaysia-prod",
  "messagingSenderId": "...",
  "appId": {
    "ios": "...",
    "android": "..."
  }
}
```

**Files to Create:**
- `google-services.json` (Android)
- `GoogleService-Info.plist` (iOS)
- `.env.production` with Firebase config

### Authentication Implementation

**File:** `frontend/src/services/auth/FirebaseAuthService.ts` (new file)

```typescript
import auth from '@react-native-firebase/auth';
import { PDPAComplianceService } from './pdpa/PDPAComplianceService';

class FirebaseAuthService {
  async registerWithEmail(email: string, password: string, pdpaConsent: ConsentData) {
    // 1. Validate PDPA consent
    await PDPAComplianceService.validateConsent(pdpaConsent);

    // 2. Create Firebase user
    const userCredential = await auth().createUserWithEmailAndPassword(email, password);

    // 3. Log consent to database
    await PDPAComplianceService.logConsent(userCredential.user.uid, pdpaConsent);

    // 4. Create user profile
    await this.createUserProfile(userCredential.user);

    return userCredential.user;
  }

  async loginWithEmail(email: string, password: string) {
    const userCredential = await auth().signInWithEmailAndPassword(email, password);

    // Update session in Redis
    await this.updateSession(userCredential.user.uid);

    return userCredential.user;
  }

  async loginWithGoogle() {
    const { idToken } = await GoogleSignin.signIn();
    const googleCredential = auth.GoogleAuthProvider.credential(idToken);
    const userCredential = await auth().signInWithCredential(googleCredential);

    // Check if PDPA consent needed (new user)
    if (userCredential.additionalUserInfo?.isNewUser) {
      throw new Error('PDPA_CONSENT_REQUIRED');
    }

    return userCredential.user;
  }

  async logout() {
    const userId = auth().currentUser?.uid;

    // Clear Redis session
    await this.clearSession(userId);

    // Firebase logout
    await auth().signOut();
  }
}
```

**File:** `frontend/src/screens/auth/RegistrationScreen.tsx` (update)

```typescript
export default function RegistrationScreen() {
  const [step, setStep] = useState(1); // 1: Email/Password, 2: PDPA Consent, 3: Profile

  const handleRegister = async (email, password, consent) => {
    try {
      await FirebaseAuthService.registerWithEmail(email, password, consent);
      navigation.navigate('Home');
    } catch (error) {
      if (error.code === 'auth/email-already-in-use') {
        setError('Email already registered');
      }
    }
  };

  if (step === 2) {
    return <PDPAConsentScreen onAccept={(consent) => {
      setConsent(consent);
      setStep(3);
    }} />;
  }

  // ...
}
```

### PDPA Consent Flow

**File:** `frontend/src/screens/auth/PDPAConsentScreen.tsx` (new file)

```typescript
export default function PDPAConsentScreen({ onAccept }) {
  const [consents, setConsents] = useState({
    essentialData: false,      // Required
    healthData: false,          // Required
    familySharing: false,       // Optional
    analytics: false,           // Optional
    marketing: false            // Optional
  });

  const consentItems = [
    {
      id: 'essentialData',
      required: true,
      title: 'Essential Data Collection',
      description: 'We collect your email, name, and basic profile information to provide core app functionality.',
      legalBasis: 'PDPA 2010 Section 6(1) - Consent'
    },
    {
      id: 'healthData',
      required: true,
      title: 'Health Information Processing',
      description: 'We process your medication data, adherence logs, and health records to provide medication reminders and tracking.',
      legalBasis: 'PDPA 2010 Section 6(1) - Consent, Section 40 - Sensitive Personal Data'
    },
    {
      id: 'familySharing',
      required: false,
      title: 'Family Circle Data Sharing',
      description: 'Allow designated family members to view your medication adherence and receive notifications.',
      legalBasis: 'PDPA 2010 Section 6(1) - Consent'
    },
    {
      id: 'analytics',
      required: false,
      title: 'Usage Analytics',
      description: 'Help us improve MediMate by sharing anonymized usage patterns and app performance data.',
      legalBasis: 'PDPA 2010 Section 6(1) - Consent'
    },
    {
      id: 'marketing',
      required: false,
      title: 'Health Education Updates',
      description: 'Receive personalized health education content and feature announcements.',
      legalBasis: 'PDPA 2010 Section 6(1) - Consent'
    }
  ];

  const handleAccept = () => {
    // Validate required consents
    if (!consents.essentialData || !consents.healthData) {
      Alert.alert('Required Consent', 'You must accept essential data and health data processing to use MediMate.');
      return;
    }

    const consentData = {
      timestamp: new Date().toISOString(),
      version: '1.0',
      consents: consents,
      ipAddress: DeviceInfo.getIpAddress(),
      userAgent: DeviceInfo.getUserAgent()
    };

    onAccept(consentData);
  };

  return (
    <ScrollView>
      <Text style={styles.title}>Privacy & Data Protection</Text>
      <Text style={styles.subtitle}>
        MediMate complies with Malaysia Personal Data Protection Act 2010.
        Please review and accept the following data processing terms.
      </Text>

      {consentItems.map(item => (
        <ConsentItem
          key={item.id}
          {...item}
          value={consents[item.id]}
          onChange={(value) => setConsents({...consents, [item.id]: value})}
        />
      ))}

      <Button title="Accept & Continue" onPress={handleAccept} />
      <Button title="Read Full Privacy Policy" onPress={openPrivacyPolicy} />
    </ScrollView>
  );
}
```

### Push Notification Integration

**File:** `frontend/src/services/notifications/FCMService.ts` (new file)

```typescript
import messaging from '@react-native-firebase/messaging';
import { Platform } from 'react-native';

class FCMService {
  async initialize() {
    // Request permission (iOS)
    if (Platform.OS === 'ios') {
      const authStatus = await messaging().requestPermission();
      const enabled =
        authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
        authStatus === messaging.AuthorizationStatus.PROVISIONAL;

      if (!enabled) {
        console.log('Push notification permission denied');
        return false;
      }
    }

    // Get FCM token
    const fcmToken = await messaging().getToken();

    // Register token with backend
    await this.registerToken(fcmToken);

    // Listen for token refresh
    messaging().onTokenRefresh(async (newToken) => {
      await this.registerToken(newToken);
    });

    // Foreground message handler
    messaging().onMessage(async remoteMessage => {
      await this.handleForegroundNotification(remoteMessage);
    });

    return true;
  }

  async registerToken(token: string) {
    const userId = auth().currentUser?.uid;
    if (!userId) return;

    await api.post('/api/notifications/register-token', {
      userId,
      token,
      platform: Platform.OS,
      deviceId: DeviceInfo.getUniqueId()
    });
  }

  async handleForegroundNotification(remoteMessage) {
    // Display in-app notification
    if (remoteMessage.data?.type === 'medication_reminder') {
      showInAppNotification({
        title: remoteMessage.notification.title,
        body: remoteMessage.notification.body,
        medicationId: remoteMessage.data.medicationId
      });
    }
  }

  async sendTestNotification(userId: string) {
    // For testing only
    await api.post('/api/notifications/test', { userId });
  }
}
```

**Backend Integration:**

**File:** `backend/src/services/notifications/FCMService.ts` (update)

```typescript
import admin from 'firebase-admin';

class FCMService {
  async sendMedicationReminder(userId: string, medication: Medication) {
    const user = await User.findById(userId);
    const fcmToken = await this.getFCMToken(userId);

    if (!fcmToken) {
      console.log(`No FCM token for user ${userId}`);
      return false;
    }

    const message = {
      token: fcmToken,
      notification: {
        title: `Time for ${medication.name}`,
        body: `Take ${medication.dosage} now`,
      },
      data: {
        type: 'medication_reminder',
        medicationId: medication.id,
        timestamp: new Date().toISOString()
      },
      android: {
        priority: 'high',
        notification: {
          sound: 'default',
          channelId: 'medication_reminders'
        }
      },
      apns: {
        payload: {
          aps: {
            sound: 'default',
            badge: 1
          }
        }
      }
    };

    try {
      const response = await admin.messaging().send(message);
      console.log('Successfully sent FCM message:', response);

      // Log notification delivery
      await NotificationLog.create({
        userId,
        type: 'medication_reminder',
        status: 'sent',
        fcmMessageId: response
      });

      return true;
    } catch (error) {
      console.error('FCM send error:', error);

      // Log failure
      await NotificationLog.create({
        userId,
        type: 'medication_reminder',
        status: 'failed',
        error: error.message
      });

      return false;
    }
  }
}
```

## Testing Requirements

### Authentication Tests

```typescript
describe('FirebaseAuthService', () => {
  it('should register user with PDPA consent', async () => {
    const consent = {
      essentialData: true,
      healthData: true,
      timestamp: new Date().toISOString()
    };

    const user = await FirebaseAuthService.registerWithEmail(
      'test@example.com',
      'Password123!',
      consent
    );

    expect(user.uid).toBeDefined();

    // Verify consent logged
    const consentRecord = await PDPAConsent.findOne({ userId: user.uid });
    expect(consentRecord).toBeDefined();
    expect(consentRecord.consents.essentialData).toBe(true);
  });

  it('should reject registration without required consent', async () => {
    const consent = {
      essentialData: false, // Missing required consent
      healthData: true
    };

    await expect(
      FirebaseAuthService.registerWithEmail('test@example.com', 'Password123!', consent)
    ).rejects.toThrow('Required consent not provided');
  });

  it('should handle Google OAuth flow', async () => {
    // Mock Google Sign-In
    jest.spyOn(GoogleSignin, 'signIn').mockResolvedValue({
      idToken: 'mock-id-token'
    });

    const user = await FirebaseAuthService.loginWithGoogle();
    expect(user.uid).toBeDefined();
  });
});
```

### Push Notification Tests

```typescript
describe('FCMService', () => {
  it('should register FCM token on initialization', async () => {
    const mockToken = 'mock-fcm-token';
    jest.spyOn(messaging(), 'getToken').mockResolvedValue(mockToken);

    await FCMService.initialize();

    const user = await User.findById(testUserId);
    expect(user.fcmTokens).toContain(mockToken);
  });

  it('should send medication reminder via FCM', async () => {
    const sendSpy = jest.spyOn(admin.messaging(), 'send').mockResolvedValue('message-id');

    const sent = await FCMService.sendMedicationReminder(testUserId, testMedication);

    expect(sent).toBe(true);
    expect(sendSpy).toHaveBeenCalledWith(
      expect.objectContaining({
        notification: expect.objectContaining({
          title: expect.stringContaining(testMedication.name)
        })
      })
    );
  });
});
```

## Definition of Done

- [ ] Firebase project configured (prod + staging)
- [ ] Firebase Auth integrated (email/password, Google, Apple)
- [ ] All mock authentication removed
- [ ] PDPA consent screen in registration
- [ ] Consent logging to database working
- [ ] Firebase Cloud Messaging configured
- [ ] FCM tokens registered for all users
- [ ] Test push notifications delivered successfully
- [ ] Reminder engine connected to FCM (not AsyncStorage)
- [ ] All AsyncStorage notification mocks removed
- [ ] Session management using Redis
- [ ] All tests passing (30+ tests)
- [ ] Security review completed
- [ ] Code reviewed and approved

## Dependencies

**Requires:**
- Issue #42 complete (navigation working)

**Blocks:**
- Issue #44 (Week 3 - needs real notifications for SMS fallback)

**External:**
- Firebase project approval (Day 1)
- Google OAuth credentials (Day 2)
- Apple Developer account (Day 2)

## Risks & Mitigation

**Risk 1: Firebase project approval delays**
- **Probability:** Low
- **Impact:** 1-2 day delay
- **Mitigation:** Start approval process in Week 1
- **Contingency:** Use Firebase emulator for development

**Risk 2: Apple Sign-In complexity**
- **Probability:** Medium
- **Impact:** 2-3 day delay
- **Mitigation:** Defer to optional, launch with email/Google only
- **Contingency:** Add Apple Sign-In post-beta

**Risk 3: PDPA consent legal review**
- **Probability:** Medium
- **Impact:** Content changes only
- **Mitigation:** Use pre-reviewed PDPA templates
- **Contingency:** Launch with basic consent, enhance later

## Success Metrics

**Day 10 Targets:**
- [ ] 100% real authentication (0% mock)
- [ ] 100% real push notifications (0% AsyncStorage)
- [ ] 100% PDPA consent compliance
- [ ] >95% FCM delivery success rate
- [ ] <500ms average auth response time
- [ ] 0 security vulnerabilities found

## Resources

**Team:**
- Developer 1 (Frontend): Firebase Auth + PDPA UI
- Developer 2 (Frontend): FCM integration
- Developer 3 (Backend): Auth API + FCM backend

**Time Allocation:**
- Firebase Auth: 2 days
- PDPA consent: 1.5 days
- FCM integration: 1.5 days

**Budget Breakdown:**
- Development: RM 90K (3 devs × 5 days)
- Firebase costs: RM 10K (initial setup)
- Testing: RM 10K
**Total:** RM 110K

## Deliverables

1. Firebase project configuration files
2. `FirebaseAuthService.ts` (new)
3. `PDPAConsentScreen.tsx` (new)
4. `FCMService.ts` (frontend + backend updates)
5. Updated registration flow
6. Updated login flow
7. PDPA consent database schema
8. FCM token management
9. 30+ test cases
10. Security audit report

## Next Steps

Upon completion:
1. Merge to main branch
2. Deploy to staging with Firebase
3. End-to-end auth testing
4. Kick off Week 3: Cultural Settings & SMS
5. Update epic progress (40% → 60%)
